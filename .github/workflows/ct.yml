name: Continuous Training

on:
  pull_request:
    branches: [develop]
    types: [closed] # Solo se activa cuando el PR se cierra (ya sea mergeado o descartado)

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}

jobs:
  trigger-training:
    # La condici√≥n estricta: Solo si fue merged y viene de una rama feature/
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    
    environment: DEV
    runs-on: ubuntu-latest
      
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Submit Custom Job to Vertex AI
        run: |
          # 1. Limpiamos TOP_FEATURES reemplazando comas por pipes (|) para no romper el comando gcloud
          SAFE_TOP_FEATURES=$(echo "${{ vars.TOP_FEATURES }}" | tr ',' '|')

          # 2. Construimos los argumentos de Python concatenando la variable sin espacios extra
          JOB_ARGS="--data_path=${{ vars.DATA_PATH }}"
          JOB_ARGS="$JOB_ARGS,--bucket_name=${{ vars.BUCKET_NAME }}"
          JOB_ARGS="$JOB_ARGS,--project_id=${{ vars.GCP_PROJECT_ID }}"
          JOB_ARGS="$JOB_ARGS,--model_secret_key=${{ secrets.MI_API_SECRET }}"
          JOB_ARGS="$JOB_ARGS,--commit_sha=${{ github.sha }}"
          JOB_ARGS="$JOB_ARGS,--delay_threshold_minutes=${{ vars.DELAY_THRESHOLD_MINUTES }}"
          JOB_ARGS="$JOB_ARGS,--learning_rate=${{ vars.LEARNING_RATE }}"
          JOB_ARGS="$JOB_ARGS,--model_path=${{ vars.MODEL_PATH }}"
          JOB_ARGS="$JOB_ARGS,--random_state=${{ vars.RANDOM_STATE }}"
          JOB_ARGS="$JOB_ARGS,--top_features=$SAFE_TOP_FEATURES"

          # 3. Lanzamos el Job pasando toda la variable a --args
          gcloud ai custom-jobs create \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --region="${{ vars.GCP_REGION }}" \
            --display-name="ct-onnx-train-${{ github.run_id }}" \
            --labels=env=dev,workflow=continuous-training \
            --worker-pool-spec="machine-type=n1-highmem-2,replica-count=1,executor-image-uri=python:3.12-slim,local-package-path=./,script=challenge/model_train.py,extra-dirs=data;tests" \
            --args="$JOB_ARGS"