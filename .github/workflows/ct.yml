name: Continuous Training

on:
  workflow_call:
    inputs:
      env_name:
        required: true
        type: string

jobs:
  execute-ct:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write

    environment: ${{ inputs.env_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Submit and Wait for Vertex AI Job
        id: vertex-job
        run: |
          # 1. Variables
          ENV_LOWER=$(echo "${{ inputs.env_name }}" | tr '[:upper:]' '[:lower:]')
          SAFE_TOP_FEATURES=$(echo "${{ vars.TOP_FEATURES }}" | tr ',' '|')
          JOB_NAME="ct-onnx-train-${{ github.sha }}"

          # 2. Argumentos de entrenamiento
          JOB_ARGS="--data_path=${{ vars.DATA_PATH }}"
          JOB_ARGS="$JOB_ARGS,--bucket_name=${{ vars.BUCKET_NAME }}"
          JOB_ARGS="$JOB_ARGS,--project_id=${{ vars.GCP_PROJECT_ID }}"
          JOB_ARGS="$JOB_ARGS,--commit_sha=${{ github.sha }}"
          JOB_ARGS="$JOB_ARGS,--delay_threshold_minutes=${{ vars.DELAY_THRESHOLD_MINUTES }}"
          JOB_ARGS="$JOB_ARGS,--learning_rate=${{ vars.LEARNING_RATE }}"
          JOB_ARGS="$JOB_ARGS,--model_path=${{ vars.MODEL_PATH }}"
          JOB_ARGS="$JOB_ARGS,--random_state=${{ vars.RANDOM_STATE }}"
          JOB_ARGS="$JOB_ARGS,--top_features=$SAFE_TOP_FEATURES"

          echo "Lanzando Custom Job en Vertex AI: $JOB_NAME"

          # 3. Lanzamiento y captura limpia del ID usando archivo temporal para evitar ruidos de logs
          gcloud ai custom-jobs create \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --region="${{ vars.GCP_REGION }}" \
            --display-name="$JOB_NAME" \
            --labels=env=$ENV_LOWER,workflow=continuous-training \
            --worker-pool-spec="machine-type=n1-highmem-2,replica-count=1,executor-image-uri=python:3.12-slim,local-package-path=./,script=challenge/model_train.py,extra-dirs=data;tests" \
            --args="$JOB_ARGS" \
            --format="value(name)" --quiet > job_output.txt 2>&1 || true

          RAW_JOB_ID=$(grep -o "projects/.*/customJobs/[0-9]*" job_output.txt | head -n 1 | xargs)
          
          if [ -z "$RAW_JOB_ID" ]; then
            echo "Error: No se pudo capturar el ID del Job. Revisar logs de GCP."
            cat job_output.txt
            exit 1
          fi

          echo "Job ID detectado: $RAW_JOB_ID"

          # 4. Monitoreo usando stream-logs para mayor eficiencia
          echo "Conectando con los logs de Vertex AI..."
          gcloud ai custom-jobs stream-logs "$RAW_JOB_ID" \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --region="${{ vars.GCP_REGION }}"

      - name: Update model_config.json and Push to Repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Actualizacion del JSON
          jq --arg sha "${{ github.sha }}" '.MODEL_VERSION = $sha' model_config.json > tmp.json && mv tmp.json model_config.json
          
          # Configuracion de Git
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          
          git add model_config.json
          
          # Commit y push si hay cambios
          if git diff --staged --quiet; then
            echo "Sin cambios en el JSON."
          else
            git commit -m "chore(mlops): actualiza MODEL_VERSION a ${{ github.sha }} [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
          fi