name: Continuous Training

on:
  workflow_call:
    inputs:
      env_name:
        required: true
        type: string

jobs:
  execute-ct:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write

    environment: ${{ inputs.env_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Submit and Wait for Vertex AI Job
        id: vertex-job
        run: |
          # 1. Variables
          ENV_LOWER=$(echo "${{ inputs.env_name }}" | tr '[:upper:]' '[:lower:]')
          SAFE_TOP_FEATURES=$(echo "${{ vars.TOP_FEATURES }}" | tr ',' '|')
          JOB_NAME="ct-onnx-train-${{ github.sha }}"

          # 2. Argumentos de entrenamiento
          JOB_ARGS="--data_path=${{ vars.DATA_PATH }}"
          JOB_ARGS="$JOB_ARGS,--bucket_name=${{ vars.BUCKET_NAME }}"
          JOB_ARGS="$JOB_ARGS,--project_id=${{ vars.GCP_PROJECT_ID }}"
          JOB_ARGS="$JOB_ARGS,--commit_sha=${{ github.sha }}"
          JOB_ARGS="$JOB_ARGS,--delay_threshold_minutes=${{ vars.DELAY_THRESHOLD_MINUTES }}"
          JOB_ARGS="$JOB_ARGS,--learning_rate=${{ vars.LEARNING_RATE }}"
          JOB_ARGS="$JOB_ARGS,--model_path=${{ vars.MODEL_PATH }}"
          JOB_ARGS="$JOB_ARGS,--random_state=${{ vars.RANDOM_STATE }}"
          JOB_ARGS="$JOB_ARGS,--top_features=$SAFE_TOP_FEATURES"

          echo "Lanzando Custom Job en Vertex AI: $JOB_NAME"

          # 3. Lanzamiento y captura limpia del ID
          # Redirigimos stderr a /dev/null para evitar que los logs de docker contaminen la variable
          RAW_JOB_ID=$(gcloud ai custom-jobs create \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --region="${{ vars.GCP_REGION }}" \
            --display-name="$JOB_NAME" \
            --labels=env=$ENV_LOWER,workflow=continuous-training \
            --worker-pool-spec="machine-type=n1-highmem-2,replica-count=1,executor-image-uri=python:3.12-slim,local-package-path=./,script=challenge/model_train.py,extra-dirs=data;tests" \
            --args="$JOB_ARGS" \
            --format="value(name)" --quiet 2>/dev/null | xargs)
          
          if [ -z "$RAW_JOB_ID" ]; then
            echo "Error: No se pudo capturar el ID del Job. Revisar logs de GCP."
            exit 1
          fi

          echo "Job ID detectado: $RAW_JOB_ID"

          # 4. Monitoreo del estado (Polling)
          echo "Monitoreando entrenamiento (Max 20 min)..."
          MAX_RETRIES=60
          COUNT=0

          while [ $COUNT -lt $MAX_RETRIES ]; do
            STATUS=$(gcloud ai custom-jobs describe "$RAW_JOB_ID" \
              --project="${{ vars.GCP_PROJECT_ID }}" \
              --region="${{ vars.GCP_REGION }}" \
              --format="value(state)")
            
            echo "[$(date +%H:%M:%S)] Estado actual: $STATUS"

            if [[ "$STATUS" == "JOB_STATE_SUCCEEDED" ]]; then
              echo "Entrenamiento finalizado con exito."
              exit 0
            elif [[ "$STATUS" == "JOB_STATE_FAILED" || "$STATUS" == "JOB_STATE_CANCELLED" || "$STATUS" == "JOB_STATE_ERROR" ]]; then
              echo "El entrenamiento fallo en Vertex AI con estado: $STATUS"
              gcloud ai custom-jobs describe "$RAW_JOB_ID" \
                --project="${{ vars.GCP_PROJECT_ID }}" \
                --region="${{ vars.GCP_REGION }}" \
                --format="value(error.message)" || echo "No se obtuvo detalle del error."
              exit 1
            fi

            COUNT=$((COUNT+1))
            sleep 20
          done

          echo "Timeout: El Job tardo demasiado."
          exit 1

      - name: Update model_config.json and Push to Repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Actualizacion del JSON
          jq --arg sha "${{ github.sha }}" '.MODEL_VERSION = $sha' model_config.json > tmp.json && mv tmp.json model_config.json
          
          # Configuracion de Git
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          
          git add model_config.json
          
          # Commit y push si hay cambios
          if git diff --staged --quiet; then
            echo "Sin cambios en el JSON."
          else
            git commit -m "chore(mlops): actualiza MODEL_VERSION a ${{ github.sha }} [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
          fi