name: Continuous Training

on:
  workflow_call:
    inputs:
      env_name:
        required: true
        type: string

jobs:
  execute-ct:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    # 1. Cargamos el entorno dinÃ¡mico (DEV, TEST, PROD) 
    environment: ${{ inputs.env_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker gcr.io --quiet

      # Construccion de argumentos 
      - name: Submit Custom Job to Vertex AI
        run: |
          ENV_LOWER=$(echo "${{ inputs.env_name }}" | tr '[:upper:]' '[:lower:]')

          SAFE_TOP_FEATURES=$(echo "${{ vars.TOP_FEATURES }}" | tr ',' '|')

          JOB_ARGS="--data_path=${{ vars.DATA_PATH }}"
          JOB_ARGS="$JOB_ARGS,--bucket_name=${{ vars.BUCKET_NAME }}"
          JOB_ARGS="$JOB_ARGS,--project_id=${{ vars.GCP_PROJECT_ID }}"
          JOB_ARGS="$JOB_ARGS,--commit_sha=${{ github.sha }}"
          JOB_ARGS="$JOB_ARGS,--delay_threshold_minutes=${{ vars.DELAY_THRESHOLD_MINUTES }}"
          JOB_ARGS="$JOB_ARGS,--learning_rate=${{ vars.LEARNING_RATE }}"
          JOB_ARGS="$JOB_ARGS,--model_path=${{ vars.MODEL_PATH }}"
          JOB_ARGS="$JOB_ARGS,--random_state=${{ vars.RANDOM_STATE }}"
          JOB_ARGS="$JOB_ARGS,--top_features=$SAFE_TOP_FEATURES"

          echo "Lanzando Job en Vertex AI para ambiente: $ENV_LOWER"

          gcloud ai custom-jobs create \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --region="${{ vars.GCP_REGION }}" \
            --display-name="ct-onnx-train-${{ github.sha }}" \
            --labels=env=$ENV_LOWER,workflow=continuous-training \
            --worker-pool-spec="machine-type=n1-highmem-2,replica-count=1,executor-image-uri=python:3.12-slim,local-package-path=./,script=challenge/model_train.py,extra-dirs=data;tests" \
            --args="$JOB_ARGS"

      # Auto-actualizacion de la version del modelo
      - name: Update model_config.json and Push to Repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Actualizando model_config.json con el SHA: ${{ github.sha }}"
          
          jq --arg sha "${{ github.sha }}" '.MODEL_VERSION = $sha' model_config.json > tmp.json && mv tmp.json model_config.json
          
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          
          git add model_config.json
          git commit -m "actualiza MODEL_VERSION a ${{ github.sha }} [skip ci]" || echo "No hay cambios que commitear"
          git push
