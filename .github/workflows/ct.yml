name: Continuous Training

on:
  pull_request:
    branches: [develop]
    types: [closed]

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
  DATA_PATH: ${{ vars.DATA_PATH }}
  TOP_FEATURES: ${{ vars.TOP_FEATURES }}
  DELAY_THRESHOLD_MINUTES: ${{ vars.DELAY_THRESHOLD_MINUTES }}
  LEARNING_RATE: ${{ vars.LEARNING_RATE }}
  MODEL_PATH: ${{ vars.MODEL_PATH }}
  RANDOM_STATE: ${{ vars.RANDOM_STATE }}
  MODEL_SECRET_KEY: ${{ secrets.MI_API_SECRET }}

jobs:
  trigger-training:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    environment: DEV
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Submit Vertex AI Custom Training Job
        run: |
          set -e

          cat <<EOF > job.yaml
          workerPoolSpecs:
            - machineSpec:
                machineType: n1-highmem-2
              replicaCount: 1
              containerSpec:
                imageUri: python:3.12-slim
                env:
                  - name: DATA_PATH
                    value: "${DATA_PATH}"
                  - name: BUCKET_NAME
                    value: "${BUCKET_NAME}"
                  - name: PROJECT_ID
                    value: "${GCP_PROJECT_ID}"
                  - name: MODEL_SECRET_KEY
                    value: "${MODEL_SECRET_KEY}"
                  - name: COMMIT_SHA
                    value: "${GITHUB_SHA}"
                  - name: TOP_FEATURES
                    value: "${TOP_FEATURES}"
                  - name: DELAY_THRESHOLD_MINUTES
                    value: "${DELAY_THRESHOLD_MINUTES}"
                  - name: LEARNING_RATE
                    value: "${LEARNING_RATE}"
                  - name: MODEL_PATH
                    value: "${MODEL_PATH}"
                  - name: RANDOM_STATE
                    value: "${RANDOM_STATE}"
              pythonPackageSpec:
                executorImageUri: python:3.12-slim
                pythonModule: challenge.model_train
                localPackagePath: .
          EOF

          gcloud ai custom-jobs create \
            --project="${GCP_PROJECT_ID}" \
            --region="${GCP_REGION}" \
            --display-name="ct-onnx-train-${GITHUB_RUN_ID}" \
            --labels=env=dev,workflow=continuous-training \
            --config=job.yaml