name: Continuous Integration 

on:
  pull_request:
    branches: [develop,  'release/*', main]
    types: [closed] 

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  TOP_FEATURES: ${{ vars.TOP_FEATURES }}
  DELAY_THRESHOLD_MINUTE: ${{ vars.DELAY_THRESHOLD_MINUTE }}
  LEARNING_RATE: ${{ vars.LEARNING_RATE }}
  RANDOM_STATE: ${{ vars.RANDOM_STATE }}
  MODEL_PATH: ${{ vars.ODEL_PAT }}
  MODEL_VERSION: ${{ vars.MODEL_VERSION }}
  DATA_LOCAL_PATH: ${{ vars.DATA_LOCAL_PATH }}
  DATA_PATH: ${{ vars.DATA_PATH }}
  MODEL_LOCAL_PATH: ${{ vars.MODEL_LOCAL_PATH }}

jobs:
  trigger-CI:
    # La condici√≥n estricta: Solo si fue merged y viene de una rama feature/
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    
    environment: DEV
    runs-on: ubuntu-latest
      
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run Model Unit Tests
        run: make model-test

      - name: Run API Integration Tests
        run: make api-test
